#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>
#include <stdbool.h>

#define MAX_MAT 50
#define MAX_TRANS 50

#define RESET   "\033[0m"
#define RED     "\033[31m"
#define GREEN   "\033[32m"
#define YELLOW  "\033[33m"
#define BLUE    "\033[34m"
#define MAGENTA "\033[35m"
#define CYAN    "\033[36m"
#define BOLD    "\033[1m"

typedef struct Material{
    char matID[10];
    char name[50];
    char unit[10];
    int qty;
    int status;
    char category[20];
} Material;

typedef struct Transaction{
    char transID[20];
    char matID[10];
    char type[5];
    char date[15];
    int amount;
} Transaction;

void menu();
void clearBuffer();
int inputIntRange(int min, int max);
int isValidMaterial(char *id);
int isDuplicateMaterial(Material *list, int count, char *ID);
void inputID(char *id, Material *list, int count, bool checkDuplicate);
void inputMaterial(Material *material, Material *list, int count);
void updateMaterial(Material *list, int count);
void manageStatus(Material *list, int count);
void searchMaterial(Material *list, int count);
void printMaterial(Material *list, int count);
void sortMaterial(Material *materials, int countMaterial);
void transactionMenu(Material *materials, int countMat, Transaction *trans, int *countTrans);
void viewTransactionHistory(Transaction logs[], int logCount);

int main() {
    Material *materials = malloc(MAX_MAT * sizeof(Material));
    Transaction *trans = malloc(MAX_TRANS * sizeof(Transaction));
    int countMaterial = 15;
    int countTransaction = 0;
    int option;

    Material sampleMaterials[15] = {
        {"KDNC3","Pen","Piece",100,1,"Household"},
        {"HDBE90","Notebook","Piece",200,1,"Household"},
        {"HDNR56","Ruler","Piece",50,1,"Household"},
        {"MSK90","Laptop","Piece",10,1,"Electronics"},
        {"GDEHW","Phone","Piece",25,1,"Electronics"},
        {"94HDN","Headphone","Piece",40,1,"Electronics"},
        {"27JDN","Rice","Kg",500,1,"Essential"},
        {"KD78DN","Sugar","Kg",300,1,"Essential"},
        {"En7DCJ8","Man Oil","L",150,1,"Essential"},
        {"KDN1O","Desk","Piece",15,1,"Household"},
        {"KDNCW","Chair","Piece",20,1,"Household"},
        {"KDLC87","USB","Piece",60,1,"Electronics"},
        {"36CNQK","Hard Drive","Piece",30,1,"Electronics"},
        {"CNS01","Milk","Box",100,1,"Essential"},
        {"778ND","Egg","Piece",200,1,"Essential"}
    };

    for (int i = 0; i < 15; i++) {
        materials[i] = sampleMaterials[i];
    }

    while(1){
        menu();
        option = inputIntRange(0,8);
        switch(option){
            case 1:
                if(countMaterial >= MAX_MAT){
                    printf(RED "Material list full!\n" RESET);
                    break;
                }
                inputMaterial(&materials[countMaterial], materials, countMaterial);
                countMaterial++;
                break;
            case 2:
                if(countMaterial == 0) {
                    printf(YELLOW "No material available!\n" RESET);
                    break;
                }
                updateMaterial(materials, countMaterial);
                break;
            case 3:
                manageStatus(materials, countMaterial);
                break;
            case 4:
                searchMaterial(materials, countMaterial);
                break;
            case 5:
                printMaterial(materials, countMaterial);
                break;
            case 6:
                sortMaterial(materials, countMaterial);
                break;
            case 7:
                transactionMenu(materials, countMaterial, trans, &countTransaction);
                break;
            case 8:
                viewTransactionHistory(trans, countTransaction);
                break;
            case 0:
                free(materials);
                free(trans);
                exit(0);
        }
    }
}

void clearBuffer(){
    int a;
    while((a=getchar()) != '\n' && a != EOF);
}

int inputIntRange(int min, int max){
    int x;
    char c;
    while (1) {
        if(scanf("%d%c", &x, &c) != 2 || c != '\n'){
            printf(RED "Invalid input! Enter a number: " RESET);
            clearBuffer();
            continue;
        }
        if(x < min || x > max){
            printf(YELLOW "Input must be between [%d - %d]: " RESET, min, max);
            continue;
        }
        return x;
    }
}

int isValidMaterial(char *id){
    id[strcspn(id,"\n")] = '\0';
    int len = strlen(id);
    if(len == 0 || len > 9) return 0;
    for(int i=0;i<len;i++){
        if(!isalnum(id[i])) return 0;
    }
    return 1;
}

int isDuplicateMaterial(Material *list,int count,char *ID){
    for (int i = 0; i < count; i++) {
        if (strcmp(list[i].matID,ID) == 0){
            return 1;
        }
    }
    return 0;
}

void inputID(char *id, Material *list, int count, bool checkDuplicate){
    while(1){
        printf("Enter material ID (max 9 chars, letters/numbers only): ");
        fgets(id, 10, stdin);
        id[strcspn(id,"\n")]=0;
        if(!isValidMaterial(id)){
            printf(RED "Invalid ID! Try again.\n" RESET);
            continue;
        }
        if(checkDuplicate && list!=NULL && isDuplicateMaterial(list,count,id)){
            printf(RED "ID already exists! Enter another.\n" RESET);
            continue;
        }
        break;
    }
}

void menu() {
    printf(BOLD CYAN "\n=============== MATERIAL MANAGEMENT =============\n" RESET);
    printf(YELLOW "1. Add new material\n");
    printf("2. Update material\n");
    printf("3. Manage status\n");
    printf("4. Search material\n");
    printf("5. Show list (Paginated)\n");
    printf("6. Sort list\n");
    printf("7. Transaction (IN/OUT)\n");
    printf("8. Transaction history\n");
    printf(RED "0. Exit\n" RESET);
    printf(BOLD CYAN "----------------------------------------------\n"RESET);
    printf(GREEN "Choose: " RESET);
}

void inputMaterial(Material *material, Material *list, int count){
    inputID(material->matID, list, count, true);
    while(1){
        printf("Enter material name: ");
        fgets(material->name, sizeof(material->name), stdin);
        material->name[strcspn(material->name, "\n")] = '\0';
        if(strlen(material->name) == 0){
            printf(RED "Name cannot be empty!\n" RESET);
            continue;
        }
        break;
    }
    while(1){
        printf("Enter unit: ");
        fgets(material->unit, sizeof(material->unit), stdin);
        material->unit[strcspn(material->unit, "\n")] = '\0';
        if(strlen(material->unit) == 0){
            printf(RED "Unit cannot be empty!\n" RESET);
            continue;
        }
        break;
    }
    printf("Enter quantity: ");
    material->qty = inputIntRange(0, 100000);
    printf("Select category:\n1. Household\n2. Electronics\n3. Essential\nChoice: ");
    int catChoice = inputIntRange(1,3);
    switch(catChoice){
        case 1: strcpy(material->category,"Household"); break;
        case 2: strcpy(material->category,"Electronics"); break;
        case 3: strcpy(material->category,"Essential"); break;
    }
    material->status = 1;
    printf(GREEN "Material added successfully with ID %s!\n" RESET, material->matID);
}

void updateMaterial(Material *list, int count) {
    char id[10];
    inputID(id, list, count, false);
    for (int i = 0; i < count; i++) {
        if (strcmp(list[i].matID, id) == 0) {
            if (list[i].status == 0) {
                printf(RED "Material is locked!\n" RESET);
                return;
            }
            while(1){
                printf("Enter new name: ");
                fgets(list[i].name, sizeof(list[i].name), stdin);
                list[i].name[strcspn(list[i].name, "\n")] = '\0';
                if(strlen(list[i].name) == 0){
                    printf(RED "Name cannot be empty!\n" RESET);
                    continue;
                }
                break;
            }
            while(1){
                printf("Enter new unit: ");
                fgets(list[i].unit, sizeof(list[i].unit), stdin);
                list[i].unit[strcspn(list[i].unit, "\n")] = '\0';
                if(strlen(list[i].unit) == 0){
                    printf(RED "Unit cannot be empty!\n" RESET);
                    continue;
                }
                break;
            }
            printf("Enter new quantity: ");
            list[i].qty = inputIntRange(0, 100000);
            printf(GREEN "Updated successfully!\n" RESET);
            return;
        }
    }
    printf(RED "Material ID not found!\n" RESET);
}

void manageStatus(Material *list, int count){
    if(count == 0){
        printf(YELLOW "No material available!\n" RESET);
        return;
    }
    char id[10];
    inputID(id, list, count, false);
    for(int i = 0; i < count; i++){
        if(strcmp(list[i].matID,id) == 0){
            if(list[i].status==-1){
                printf(RED "Material deleted!\n" RESET);
                return;
            }
            int choice;
            if(list[i].status==1){
                printf("Material is active. Choose:\n1. Lock\n2. Delete\nChoice: ");
                choice = inputIntRange(1,2);
                if(choice==1) list[i].status=0;
                else list[i].status=-1;
            } else {
                printf("Material is locked. Choose:\n1. Unlock\n2. Delete\nChoice: ");
                choice = inputIntRange(1,2);
                if(choice==1) list[i].status=1;
                else list[i].status=-1;
            }
            printf(GREEN "Status updated!\n" RESET);
            return;
        }
    }
    printf(RED "Material ID not found!\n" RESET);
}

void searchMaterial(Material *list, int count){
    if(count==0){ printf(YELLOW "No material available!\n" RESET); return; }
    char keyword[50];
    printf("Enter ID or name to search: ");
    fgets(keyword, sizeof(keyword), stdin);
    keyword[strcspn(keyword, "\n")] = '\0';
    int found=0;
    for(int i=0;i<count;i++){
        if(strstr(list[i].matID, keyword) || strstr(list[i].name, keyword)){
            char *statusStr = (list[i].status==1) ? GREEN "Active" RESET : (list[i].status==0?YELLOW "Locked" RESET:RED "Deleted" RESET);
            printf("%-10s | %-15s | %-10s | %-7d | %-15s | %-10s\n",
                   list[i].matID, list[i].name, list[i].unit, list[i].qty, list[i].category, statusStr);
            found++;
        }
    }
    if(!found) printf(YELLOW "No matching material found!\n" RESET);
}

void printMaterial(Material *list, int count){
    int itemsPerPage=10, page=0, displayCount=0;
    for(int i=0;i<count;i++) if(list[i].status!=-1) displayCount++;
    if(displayCount==0){ printf(YELLOW "Material list is empty!\n" RESET); return; }
    int totalPages = (displayCount + itemsPerPage -1)/itemsPerPage;
    while(1){
        printf(BOLD "\n+=+=+=+=+=+=+ MATERIAL LIST (Page %d/%d) +=+=+=+=+=+=+=+=+\n" RESET, page+1, totalPages);
        printf("%-10s | %-15s | %-10s | %-7s | %-15s | %-10s\n","ID","Name","Unit","Qty","Category","Status");
        int start=page*itemsPerPage, end=start+itemsPerPage; if(end>displayCount) end=displayCount; int shown=0;
        for(int i=0;i<count && shown<end;i++){
            if(list[i].status!=-1){
                if(shown>=start){
                    char *statusStr = (list[i].status==1) ? GREEN "Active" RESET : (list[i].status==0?YELLOW "Locked" RESET:RED "Deleted" RESET);
                    printf("%-10s | %-15s | %-10s | %-7d | %-15s | %-10s\n",
                           list[i].matID,list[i].name,list[i].unit,list[i].qty,list[i].category,statusStr);
                }
                shown++;
            }
        }
        printf("\n[N] Next | [P] Previous | [Q] Quit: ");
        char c=getchar(); clearBuffer();
        if(c == 'N' || c == 'n'){ if(page+1<totalPages) page++; }
        else if(c == 'P' || c == 'p'){ if(page>0) page--; }
        else break;
    }
}

void sortMaterial(Material *materials, int countMaterial){
    int choice;
    do{
        printf("1. Sort by name (A-Z)\n2. Sort by quantity (asc)\n3. Back to menu\nChoice: ");
        choice = inputIntRange(1,3);
        if(choice==1){
            for(int i=0;i<countMaterial-1;i++)
                for(int j=0;j<countMaterial-i-1;j++)
                    if(strcasecmp(materials[j].name,materials[j+1].name)>0){
                        Material tmp=materials[j]; materials[j]=materials[j+1]; materials[j+1]=tmp;
                    }
            printMaterial(materials,countMaterial);
        } else if(choice==2){
            for(int i=0;i<countMaterial-1;i++)
                for(int j=0;j<countMaterial-i-1;j++)
                    if(materials[j].qty>materials[j+1].qty){
                        Material tmp=materials[j]; materials[j]=materials[j+1]; materials[j+1]=tmp;
                    }
            printMaterial(materials,countMaterial);
        }
    }while(choice!=3);
}

void transactionMenu(Material *materials, int countMat, Transaction *trans, int *countTrans){
    char id[10]; inputID(id, materials, countMat, false);
    for(int i=0;i<countMat;i++){
        if(strcmp(materials[i].matID,id)==0){
            if(materials[i].status==-1){ printf(RED "Material deleted!\n" RESET); return; }
            printf("1. IN\n2. OUT\nChoice: "); int choice=inputIntRange(1,2);
            printf("Enter quantity: "); int qty=inputIntRange(1,1000000);
            sprintf(trans[*countTrans].transID,"T%04d",*countTrans+1);
            strcpy(trans[*countTrans].matID,id);
            strcpy(trans[*countTrans].date,"01/12/2025");
            trans[*countTrans].amount=qty;
            if(choice==1){ strcpy(trans[*countTrans].type,"IN"); materials[i].qty+=qty; }
            else{
                if(materials[i].qty<qty){ printf(RED "Not enough quantity!\n" RESET); return; }
                strcpy(trans[*countTrans].type,"OUT"); materials[i].qty-=qty;
            }
            (*countTrans)++;
            printf(GREEN "Transaction successful! ID: %s\n" RESET, trans[*countTrans-1].transID);
            return;
        }
    }
    printf(RED "Material ID not found!\n" RESET);
}

void viewTransactionHistory(Transaction logs[], int logCount){
    char id[10]; inputID(id,NULL,0,false);
    int found=0;
    printf(BOLD "\n===== TRANSACTION HISTORY OF %s =====\n" RESET, id);
    for(int i=0;i<logCount;i++){
        if(strcmp(logs[i].matID,id)==0){
            found=1;
            printf("%-10s | %-5s | %-7d | %-10s\n",
                   logs[i].transID,
                   strcmp(logs[i].type,"IN")==0?"IN":"OUT",
                   logs[i].amount,
                   logs[i].date);
        }
    }
    if(!found) printf(YELLOW "No transaction for this material!\n" RESET);
}
